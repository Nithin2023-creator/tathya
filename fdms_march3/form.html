<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form with Personal and Educational Details</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            font-family: Arial, sans-serif;
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 400px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        fieldset {
            border: none;
            padding: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select, textarea, button {
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #b3d7ff;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .same-address-btn {
            width: auto;
            margin-top: -10px;
            margin-bottom: 15px;
            padding: 5px 10px;
        }

        .hidden {
            display: none;
        }

        .edu-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .edu-button {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
        }

        .edu-button.active {
            background-color: #007bff;
            color: white;
        }

        .edu-section {
            display: none;
        }

        .edu-section.active {
            display: block;
        }

        .higher-edu-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .higher-edu-section {
            display: none;
            margin-top: 20px;
        }

        .higher-edu-section.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 5px;
            width: auto;
            padding: 10px 20px;
        }

        .nav-button i {
            font-size: 18px;
        }

        .field-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .field-row .field-item {
            flex: 1;
        }

        .field-row label {
            margin-bottom: 5px;
        }

        .address-container {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .address-container::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #ccc;
        }

        .address-section {
            flex: 1;
            padding: 0 10px;
        }

        .address-section h3 {
            margin: 0 0 10px 0;
        }

        .perm-address-section {
            position: relative;
        }

        .same-address-btn {
            position: absolute;
            right: 0;
            bottom: -40px;
            width: auto;
            padding: 5px 10px;
            font-size: 0.9em;
            margin-right: 3%;
        }

        .grade-container {
            margin-bottom: 15px;
        }

        .grade-type-select {
            margin-bottom: 10px;
        }

        .grade-input {
            display: none;
        }

        .grade-input.active {
            display: block;
        }

        .exp-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .exp-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .location-row {
            display: flex;
            gap: 10px;
        }

        .location-row > div {
            flex: 1;
        }

        #experienceList {
            margin-top: 20px;
        }

        .experience-duration {
            font-weight: bold;
            color: #007bff;
            margin-top: 5px;
        }

        .certificate-section {
            margin-bottom: 20px;
        }

        .certificate-group {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .certificate-group h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .upload-btn {
            background-color: #28a745;
            margin-top: 5px;
        }

        .upload-btn:hover {
            background-color: #218838;
        }

        .file-name {
            font-size: 0.9em;
            color: #007bff;
            margin-top: 5px;
        }

        .confirm-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 600px;
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .terms-checkbox {
            text-align: left;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        #finalSubmitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
    <script>
        function calculateAge() {
            const dob = document.getElementById('dob').value;
            const dobDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - dobDate.getFullYear();
            const monthDiff = today.getMonth() - dobDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dobDate.getDate())) {
                age--;
            }
            document.getElementById('age').value = age;
        }

        function copyAddress() {
            document.getElementById('perm-state').value = document.getElementById('temp-state').value;
            document.getElementById('perm-city').value = document.getElementById('temp-city').value;
            document.getElementById('perm-pincode').value = document.getElementById('temp-pincode').value;
        }

        function validateEmail() {
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
            }
        }

        function validatePhone() {
            const phone = document.getElementById('phone').value;
            const phoneRegex = /^[0-9]{10}$/;
            if (!phoneRegex.test(phone)) {
                alert('Please enter a valid 10-digit phone number.');
            }
        }

        function showSection(sectionId) {
            if (sectionId === 'confirmationSection') {
                document.getElementById('confirmationSection').classList.remove('hidden');
            } else if (sectionId === 'nextSection') {
                showSection('confirmationSection');
            } else {
                document.querySelectorAll('.form-section').forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById(sectionId).classList.remove('hidden');
            }
        }

        let educationData = {
            school: { name: '', location: '', startDate: '', endDate: '', syllabusType: '', gradeType: '', grade: '' },
            intermediate: { name: '', location: '', startDate: '', endDate: '', syllabusType: '', gradeType: '', grade: '' },
            ug: { name: '', location: '', startDate: '', endDate: '', instituteType: '', course: '', specialization: '', gradeType: '', grade: '' },
            pg: { name: '', location: '', startDate: '', endDate: '', instituteType: '', course: '', specialization: '', gradeType: '', grade: '' },
            phd: { name: '', location: '', startDate: '', endDate: '', instituteType: '', course: '', specialization: '', status: '', currentYear: '', gradeType: '', grade: '' }
        };

        function showEducationSection(sectionId) {
            // Save current section data
            if (document.querySelector('.edu-section.active')) {
                const currentSection = document.querySelector('.edu-section.active').id;
                saveEducationData(currentSection);
            }

            // Update buttons
            document.querySelectorAll('.edu-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

            // Show selected section
            document.querySelectorAll('.edu-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Load saved data
            loadEducationData(sectionId);
        }

        function saveEducationData(section) {
            if (section === 'higher') {
                // Save data for active higher education section
                const activeHigherSection = document.querySelector('.higher-edu-section.active');
                if (activeHigherSection) {
                    const higherSectionId = activeHigherSection.id;
                    saveHigherEducationData(higherSectionId);
                }
            } else {
                const data = {
                    name: document.getElementById(`${section}-name`).value,
                    location: document.getElementById(`${section}-location`).value,
                    startDate: document.getElementById(`${section}-start`).value,
                    endDate: document.getElementById(`${section}-end`).value,
                    syllabusType: document.getElementById(`${section}-syllabus`)?.value || '',
                    gradeType: document.getElementById(`${section}-grade-type`).value,
                    grade: document.getElementById(`${section}-${document.getElementById(`${section}-grade-type`).value}`).value
                };
                educationData[section] = data;
            }
        }

        function saveHigherEducationData(section) {
            const data = {
                name: document.getElementById(`${section}-name`).value,
                location: document.getElementById(`${section}-location`).value,
                startDate: document.getElementById(`${section}-start`).value,
                endDate: document.getElementById(`${section}-end`).value,
                instituteType: document.getElementById(`${section}-type`).value,
                course: document.getElementById(`${section}-course`).value,
                specialization: document.getElementById(`${section}-specialization`).value,
                gradeType: document.getElementById(`${section}-grade-type`).value,
                grade: document.getElementById(`${section}-${document.getElementById(`${section}-grade-type`).value}`).value
            };

            if (section === 'phd') {
                data.status = document.getElementById('phd-status').value;
                data.currentYear = document.getElementById('phd-current-year').value;
            }

            educationData[section] = data;
        }

        function loadEducationData(section) {
            const data = educationData[section];
            document.getElementById(`${section}-name`).value = data.name || '';
            document.getElementById(`${section}-location`).value = data.location || '';
            document.getElementById(`${section}-start`).value = data.startDate || '';
            document.getElementById(`${section}-end`).value = data.endDate || '';

            if (section === 'school' || section === 'intermediate') {
                document.getElementById(`${section}-syllabus`).value = data.syllabusType || '';
            } else if (section === 'ug' || section === 'pg') {
                document.getElementById(`${section}-type`).value = data.instituteType || '';
                document.getElementById(`${section}-course`).value = data.course || '';
                document.getElementById(`${section}-specialization`).value = data.specialization || '';
            } else if (section === 'phd') {
                document.getElementById(`${section}-type`).value = data.instituteType || '';
                document.getElementById(`${section}-course`).value = data.course || '';
                document.getElementById(`${section}-specialization`).value = data.specialization || '';
                document.getElementById(`${section}-status`).value = data.status || '';
                document.getElementById(`${section}-current-year`).value = data.currentYear || '';
            }

            document.getElementById(`${section}-grade-type`).value = data.gradeType || '';
            toggleGradeInput(section);
            document.getElementById(`${section}-${data.gradeType}`).value = data.grade || '';
        }

        function updateSpecializations() {
            const section = document.querySelector('.edu-section.active').id;
            const courseSelect = document.getElementById(`${section}-course`);
            const specSelect = document.getElementById(`${section}-specialization`);
            const selectedCourse = courseSelect.value;
            
            specSelect.innerHTML = '<option value="">Select Specialization</option>';
            
            const specializations = {
                'BTech': ['AIML', 'DS', 'CSE', 'IT', 'MECHANICAL', 'EEE', 'ECE'],
                'BEd': ['Sociology', 'Science', 'Mathematics'],
                'BSc': ['Physics', 'Chemistry', 'Mathematics'],
                'MTech': ['AI', 'ML', 'DS', 'CSE', 'MECHANICAL', 'AERONAUTICAL'],
                'MSc': ['Mathematics', 'Chemistry', 'Electronics'],
                'MBA': ['Finance', 'Marketing', 'HR', 'Operations']  // Added MBA specializations
            };

            if (specializations[selectedCourse]) {
                specializations[selectedCourse].forEach(spec => {
                    const option = new Option(spec, spec);
                    specSelect.add(option);
                });
            }

            // Enable/disable specialization dropdown based on course selection
            specSelect.disabled = !selectedCourse || selectedCourse === 'MBA';
        }

        function showHigherEducationSection(sectionId) {
            document.querySelectorAll('.higher-edu-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.higher-edu-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
        }

        function togglePhdStatus() {
            const status = document.getElementById('phd-status').value;
            const phdFields = document.getElementById('phd-fields-container');
            const phdYearContainer = document.getElementById('phd-year-container');
            
            if (status === 'no') {
                phdFields.style.display = 'none';
            } else {
                phdFields.style.display = 'block';
                phdYearContainer.style.display = status === 'pursuing' ? 'block' : 'none';
            }
        }

        function validatePersonalDetails() {
            const fields = [
                'name',
                'gender',
                'dob',
                'temp-state',
                'temp-city',
                'temp-pincode',
                'perm-state',
                'perm-city',
                'perm-pincode',
                'email',
                'phone'
            ];

            const isValid = fields.every(field => {
                const element = document.getElementById(field);
                return element && element.value.trim() !== '';
            });

            document.getElementById('next-button').disabled = !isValid;
        }

        function toggleGradeInput(section) {
            const gradeType = document.getElementById(`${section}-grade-type`).value;
            document.getElementById(`${section}-cgpa`).parentElement.classList.remove('active');
            document.getElementById(`${section}-percentage`).parentElement.classList.remove('active');
            
            if (gradeType) {
                document.getElementById(`${section}-${gradeType}`).parentElement.classList.add('active');
            }
        }

        function validateGrade(input, type) {
            const value = parseFloat(input.value);
            if (type === 'cgpa' && (value < 4 || value > 10)) {
                alert('CGPA must be between 4 and 10');
                input.value = '';
            } else if (type === 'percentage' && (value < 35 || value > 100)) {
                alert('Percentage must be between 35 and 100');
                input.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const personalForm = document.getElementById('personal-form');
            const fields = personalForm.querySelectorAll('input, select');
            
            fields.forEach(field => {
                field.addEventListener('input', validatePersonalDetails);
            });

            validatePersonalDetails(); // Initial check
        });

        function validateEducationDetails() {
            const sections = ['school', 'intermediate', 'ug', 'pg'];
            const fields = ['name', 'location', 'start', 'end', 'grade-type'];
            
            // Check if all required sections are filled
            const basicFieldsValid = sections.every(section => {
                return fields.every(field => {
                    const element = document.getElementById(`${section}-${field}`);
                    return element && element.value.trim() !== '';
                });
            });

            // Check Ph.D status
            const phdStatus = document.getElementById('phd-status').value;
            const isPhdComplete = phdStatus === 'no' || (phdStatus && document.getElementById('phd-fields-container').querySelector('input, select').value);

            document.getElementById('edu-next-button').disabled = !(basicFieldsValid && isPhdComplete);
        }

        // Add event listeners for all educational fields
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing personal form validation...

            // Add validation for educational fields
            const eduForm = document.getElementById('educationalDetails');
            const eduFields = eduForm.querySelectorAll('input, select');
            
            eduFields.forEach(field => {
                field.addEventListener('input', validateEducationDetails);
                field.addEventListener('change', validateEducationDetails);
            });
        });

        let experiences = [];

        const indianStates = [
            'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
            'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka',
            'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram',
            'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu',
            'Telangana', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal'
        ];

        function addExperienceCard() {
            const card = document.createElement('div');
            card.className = 'exp-card';
            card.innerHTML = `
                <label for="org-name">Organization Name:</label>
                <input type="text" id="org-name" required>

                <div class="location-row">
                    <div>
                        <label for="org-state">State:</label>
                        <select id="org-state" required>
                            <option value="">Select State</option>
                            ${indianStates.map(state => `<option value="${state}">${state}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="org-city">City:</label>
                        <input type="text" id="org-city" required>
                    </div>
                </div>

                <label for="designation">Designation:</label>
                <input type="text" id="designation" required>

                <div class="location-row">
                    <div>
                        <label for="join-date">Date of Joining:</label>
                        <input type="date" id="join-date" required onchange="calculateExperience(this.parentElement.parentElement.parentElement)">
                    </div>
                    <div>
                        <label for="relieve-date">Date of Relieving:</label>
                        <input type="date" id="relieve-date" onchange="calculateExperience(this.parentElement.parentElement.parentElement)">
                    </div>
                </div>
                <div class="experience-duration"></div>
                <div class="button-group">
                    <button type="button" class="save-btn" onclick="saveExperience(this.parentElement.parentElement)">Save</button>
                    <button type="button" class="edit-btn" style="display:none" onclick="editExperience(this.parentElement.parentElement)">Edit</button>
                </div>
            `;
            document.getElementById('experienceList').appendChild(card);
            validateExperience();
        }

        function calculateExperience(card) {
            const joinDate = new Date(card.querySelector('#join-date').value);
            const relieveDate = card.querySelector('#relieve-date').value ? 
                              new Date(card.querySelector('#relieve-date').value) : 
                              new Date();
            
            const diffTime = Math.abs(relieveDate - joinDate);
            const diffYears = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 365));
            const diffMonths = Math.floor((diffTime % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
            
            card.querySelector('.experience-duration').textContent = 
                `Experience: ${diffYears} years ${diffMonths} months`;
        }

        function saveExperience(card) {
            const experience = {
                organization: card.querySelector('#org-name').value,
                state: card.querySelector('#org-state').value,
                city: card.querySelector('#org-city').value,
                designation: card.querySelector('#designation').value,
                joinDate: card.querySelector('#join-date').value,
                relieveDate: card.querySelector('#relieve-date').value,
                duration: card.querySelector('.experience-duration').textContent
            };

            if (!experience.organization || !experience.state || !experience.city || 
                !experience.designation || !experience.joinDate) {
                alert('Please fill all required fields');
                return;
            }

            experiences.push(experience);
            card.querySelectorAll('input, select').forEach(input => input.disabled = true);
            card.querySelector('.save-btn').style.display = 'none';
            card.querySelector('.edit-btn').style.display = 'inline-block';
            validateExperience();
        }

        function editExperience(card) {
            card.querySelectorAll('input, select').forEach(input => input.disabled = false);
            card.querySelector('.save-btn').style.display = 'inline-block';
            card.querySelector('.edit-btn').style.display = 'none';
            
            // Remove this experience from the array
            const index = experiences.findIndex(exp => 
                exp.organization === card.querySelector('#org-name').value &&
                exp.joinDate === card.querySelector('#join-date').value
            );
            if (index > -1) {
                experiences.splice(index, 1);
            }
            validateExperience();
        }

        function noExperience() {
            experiences = [];  // Just set it to empty array instead of adding a dummy object
            document.getElementById('addExpBtn').disabled = true;
            document.getElementById('noExpBtn').disabled = true;
            validateExperience();
        }

        function validateExperience() {
            // Remove this function entirely or modify it to always enable the next button
            document.getElementById('exp-next-button').disabled = false;
        }

        function setupCertificateSection() {
            // Show Ph.D certificate section if Ph.D details were entered
            const phdStatus = document.getElementById('phd-status').value;
            document.getElementById('phd-cert-group').style.display = 
                (phdStatus && phdStatus !== 'no') ? 'block' : 'none';

            // Add experience certificate sections based on experiences
            const expCertsDiv = document.getElementById('exp-certs');
            expCertsDiv.innerHTML = '';

            if (experiences.length > 0 && experiences[0].type !== 'none') {
                experiences.forEach((exp, index) => {
                    expCertsDiv.innerHTML += `
                        <div class="certificate-group">
                            <h3>Experience Certificate - ${exp.organization}</h3>
                            <input type="file" id="exp-cert-${index}" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(this)">
                            <button type="button" class="upload-btn" onclick="triggerFileInput('exp-cert-${index}')">Upload</button>
                            <div id="exp-cert-${index}-name" class="file-name"></div>
                        </div>
                    `;
                });
            }
        }

        function triggerFileInput(inputId) {
            document.getElementById(inputId).click();
        }

        function handleFileUpload(input) {
            const fileName = input.files[0]?.name || '';
            document.getElementById(`${input.id}-name`).textContent = fileName;
        }

        function handleConfirmation(response) {
            if (response === 'yes') {
                document.getElementById('termsSection').style.display = 'block';
            } else {
                showSection('certificateUpload');
            }
        }

        function toggleSubmitButton() {
            document.getElementById('finalSubmitBtn').disabled = !document.getElementById('termsCheck').checked;
        }

        function collectPhDData() {
            const status = document.getElementById('phd-status').value;
            if (status === 'no') return { status: 'no' };

            return {
                name: document.getElementById('phd-name').value,
                location: document.getElementById('phd-location').value,
                startDate: document.getElementById('phd-start').value,
                endDate: document.getElementById('phd-end').value,
                instituteType: document.getElementById('phd-type').value,
                course: document.getElementById('phd-course')?.value || '',
                specialization: document.getElementById('phd-specialization')?.value || '',
                status: status,
                currentYear: status === 'pursuing' ? 
                    parseInt(document.getElementById('phd-current-year').value) : null,
                gradeType: document.getElementById('phd-grade-type').value,
                grade: parseFloat(document.getElementById(`phd-${document.getElementById('phd-grade-type').value}`)?.value) || 0
            };
        }

        function collectPersonalData() {
            const data = {
                name: document.getElementById('name').value,
                gender: document.getElementById('gender').value,
                dob: document.getElementById('dob').value,
                age: document.getElementById('age').value,
                tempAddress: {
                    state: document.getElementById('temp-state').value,
                    city: document.getElementById('temp-city').value,
                    pincode: document.getElementById('temp-pincode').value
                },
                permAddress: {
                    state: document.getElementById('perm-state').value,
                    city: document.getElementById('perm-city').value,
                    pincode: document.getElementById('perm-pincode').value
                },
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };
            return data;
        }

        async function submitForm() {
            try {
                // Get user info from localStorage
                const userEmail = localStorage.getItem('userEmail');
                const userDepartment = localStorage.getItem('userDepartment');
                const userRole = localStorage.getItem('userRole'); // Get user role

                if (!userEmail || !userDepartment) {
                    throw new Error('User session not found. Please login again.');
                }

                // Collect education details without PhD validation
                const educationDetails = {
                    school: collectEducationData('school'),
                    intermediate: collectEducationData('intermediate'),
                    ug: collectEducationData('ug'),
                    pg: collectEducationData('pg'),
                    // Make PhD optional
                    phd: document.getElementById('phd-status')?.value === 'no' ? 
                         { status: 'no' } : 
                         collectEducationData('phd')
                };

                const formPayload = {
                    personalDetails: collectPersonalData(),
                    educationDetails,
                    experiences: experiences || [] // Use empty array if no experience
                };

                console.log('Submitting form data:', formPayload);

                const response = await fetch('http://localhost:4009/api/faculty/submit-form', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formPayload)
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Form submitted successfully!');
                    // Redirect based on user role
                    if (userRole === 'HOD') {
                        window.location.href = '/hod_dashboard';
                    } else {
                        window.location.href = '/faculty_dashboard';
                    }
                } else {
                    throw new Error(data.message || 'Form submission failed');
                }
            } catch (error) {
                console.error('Form submission error:', error);
                alert(`Error submitting form: ${error.message}`);
            }
        }

        function collectEducationData(level) {
            try {
                // If it's PhD and status is 'no', return minimal data
                if (level === 'phd') {
                    const status = document.getElementById('phd-status')?.value || 'no';
                    if (status === 'no') {
                        return { status: 'no' };
                    }
                }

                // For other levels or if PhD with status other than 'no'
                return {
                    name: document.getElementById(`${level}-name`)?.value || '',
                    location: document.getElementById(`${level}-location`)?.value || '',
                    startDate: document.getElementById(`${level}-start`)?.value || '',
                    endDate: document.getElementById(`${level}-end`)?.value || '',
                    instituteType: document.getElementById(`${level}-type`)?.value || '',
                    course: document.getElementById(`${level}-course`)?.value || '',
                    specialization: document.getElementById(`${level}-specialization`)?.value || '',
                    gradeType: document.getElementById(`${level}-grade-type`)?.value || '',
                    grade: document.getElementById(`${level}-${document.getElementById(`${level}-grade-type`)?.value}`)?.value || '',
                    status: level === 'phd' ? document.getElementById('phd-status')?.value : undefined
                };
            } catch (error) {
                console.warn(`Could not collect ${level} education data:`, error);
                return level === 'phd' ? { status: 'no' } : {};
            }
        }

        // Add this to load email when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                document.getElementById('email').value = userEmail;
                document.getElementById('email').readOnly = true; // Make email field readonly
            }
            // ...existing code...
        });

        // Add event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            
            // Add change event listeners for course dropdowns
            ['ug', 'pg'].forEach(level => {
                const courseSelect = document.getElementById(`${level}-course`);
                if (courseSelect) {
                    courseSelect.addEventListener('change', updateSpecializations);
                }
            });
        });
    </script>
</head>
<body>
    <div class="card">
        <div id="personalDetails" class="form-section">
            <!-- <h1>Personal Details Form</h1> -->
            <form id="personal-form">
                <fieldset>
                    <legend><h2>Personal Details</h2></legend>
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>

                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender" required>
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>

                    <div class="field-row">
                        <div class="field-item">
                            <label for="dob">Date of Birth:</label>
                            <input type="date" id="dob" name="dob" onchange="calculateAge()" required>
                        </div>
                        <div class="field-item">
                            <label for="age">Age:</label>
                            <input type="text" id="age" name="age" readonly>
                        </div>
                    </div>

                    <div class="address-container">
                        <div class="address-section">
                            <h3>Temporary Address</h3>
                            <label for="temp-state">State:</label>
                            <input type="text" id="temp-state" name="temp-state" required>
                            
                            <label for="temp-city">City:</label>
                            <input type="text" id="temp-city" name="temp-city" required>
                            
                            <label for="temp-pincode">Pincode:</label>
                            <input type="text" id="temp-pincode" name="temp-pincode" required>
                        </div>
                        
                        <div class="address-section perm-address-section">
                            <h3>Permanent Address</h3>
                            <label for="perm-state">State:</label>
                            <input type="text" id="perm-state" name="perm-state" required>
                            
                            <label for="perm-city">City:</label>
                            <input type="text" id="perm-city" name="perm-city" required>
                            
                            <label for="perm-pincode">Pincode:</label>
                            <input type="text" id="perm-pincode" name="perm-pincode" required>
                            
                            <button type="button" class="same-address-btn" onclick="copyAddress()">Same as Temporary</button>
                        </div>
                    </div>

                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" onblur="validateEmail()" required>

                    <label for="phone">Phone Number:</label>
                    <input type="text" id="phone" name="phone" onblur="validatePhone()" required>

                    <button type="button" id="next-button" onclick="showSection('educationalDetails')" disabled>Next</button>
                </fieldset>
            </form>
        </div>

        <div id="educationalDetails" class="form-section hidden">
            <h1>Educational Details</h1>
            <div class="edu-buttons">
                <button type="button" class="edu-button active" data-section="school" onclick="showEducationSection('school')">School</button>
                <button type="button" class="edu-button" data-section="intermediate" onclick="showEducationSection('intermediate')">Intermediate</button>
                <button type="button" class="edu-button" data-section="ug" onclick="showEducationSection('ug')">UG</button>
                <button type="button" class="edu-button" data-section="pg" onclick="showEducationSection('pg')">PG</button>
                <button type="button" class="edu-button" data-section="phd" onclick="showEducationSection('phd')">Ph.D</button>
            </div>

            <form>
                <div id="school" class="edu-section active">
                    <label for="school-name">Name of School:</label>
                    <input type="text" id="school-name" required>

                    <label for="school-location">Location:</label>
                    <input type="text" id="school-location" required>

                    <label>Duration:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="school-start" required>
                        <input type="date" id="school-end" required>
                    </div>

                    <label for="school-syllabus">Syllabus Type:</label>
                    <select id="school-syllabus" required>
                        <option value="">Select</option>
                        <option value="cbse">CBSE</option>
                        <option value="ssc">SSC</option>
                    </select>

                    <div class="grade-container">
                        <label for="school-grade-type">Grade Type:</label>
                        <select id="school-grade-type" class="grade-type-select" onchange="toggleGradeInput('school')" required>
                            <option value="">Select</option>
                            <option value="cgpa">CGPA</option>
                            <option value="percentage">Percentage</option>
                        </select>
                        
                        <div class="grade-input">
                            <label for="school-cgpa">CGPA :</label>
                            <input type="number" id="school-cgpa" step="0.01" onchange="validateGrade(this, 'cgpa')" required>
                        </div>
                        
                        <div class="grade-input">
                            <label for="school-percentage">Percentage :</label>
                            <input type="number" id="school-percentage" step="0.01" onchange="validateGrade(this, 'percentage')" required>
                        </div>
                    </div>
                </div>

                <div id="intermediate" class="edu-section">
                    <label for="intermediate-name">Name of College:</label>
                    <input type="text" id="intermediate-name" required>

                    <label for="intermediate-location">Location:</label>
                    <input type="text" id="intermediate-location" required>

                    <label>Duration:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="intermediate-start" required>
                        <input type="date" id="intermediate-end" required>
                    </div>

                    <label for="intermediate-syllabus">Syllabus Type:</label>
                    <select id="intermediate-syllabus" required>
                        <option value="">Select</option>
                        <option value="cbse">CBSE</option>
                        <option value="ssc">TSBIE</option>
                        <input type="text" placeholder="Other">
                    </select>

                    <div class="grade-container">
                        <label for="intermediate-grade-type">Grade Type:</label>
                        <select id="intermediate-grade-type" class="grade-type-select" onchange="toggleGradeInput('intermediate')" required>
                            <option value="">Select</option>
                            <option value="cgpa">CGPA</option>
                            <option value="percentage">Percentage</option>
                        </select>
                        
                        <div class="grade-input">
                            <label for="intermediate-cgpa">CGPA (4-10):</label>
                            <input type="number" id="intermediate-cgpa" step="0.01" onchange="validateGrade(this, 'cgpa')" required>
                        </div>
                        
                        <div class="grade-input">
                            <label for="intermediate-percentage">Percentage (35-100):</label>
                            <input type="number" id="intermediate-percentage" step="0.01" onchange="validateGrade(this, 'percentage')" required>
                        </div>
                    </div>
                </div>

                <div id="ug" class="edu-section">
                    <label for="ug-name">Name of Institution:</label>
                    <input type="text" id="ug-name" required>

                    <label for="ug-location">Location:</label>
                    <input type="text" id="ug-location" required>

                    <label>Duration:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="ug-start" required>
                        <input type="date" id="ug-end" required>
                    </div>

                    <label for="ug-type">Institute Type:</label>
                    <select id="ug-type" required>
                        <option value="">Select</option>
                        <option value="gov">Government</option>
                        <option value="private">Private</option>
                        <option value="deemed">Deemed</option>
                    </select>

                    <label for="ug-course">Course:</label>
                    <select id="ug-course" required onchange="updateSpecializations()">
                        <option value="">Select</option>
                        <option value="BTech">B.Tech</option>
                        <option value="BEd">B.Ed</option>
                        <option value="BSc">B.Sc</option>
                    </select>

                    <label for="ug-specialization">Specialization:</label>
                    <select id="ug-specialization" required>
                        <option value="">Select</option>
                    </select>

                    <div class="grade-container">
                        <label for="ug-grade-type">Grade Type:</label>
                        <select id="ug-grade-type" class="grade-type-select" onchange="toggleGradeInput('ug')" required>
                            <option value="">Select</option>
                            <option value="cgpa">CGPA</option>
                            <option value="percentage">Percentage</option>
                        </select>
                        
                        <div class="grade-input">
                            <label for="ug-cgpa">CGPA (4-10):</label>
                            <input type="number" id="ug-cgpa" step="0.01" onchange="validateGrade(this, 'cgpa')" required>
                        </div>
                        
                        <div class="grade-input">
                            <label for="ug-percentage">Percentage (35-100):</label>
                            <input type="number" id="ug-percentage" step="0.01" onchange="validateGrade(this, 'percentage')" required>
                        </div>
                    </div>
                </div>

                <div id="pg" class="edu-section">
                    <label for="pg-name">Name of Institution:</label>
                    <input type="text" id="pg-name" required>

                    <label for="pg-location">Location:</label>
                    <input type="text" id="pg-location" required>

                    <label>Duration:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="pg-start" required>
                        <input type="date" id="pg-end" required>
                    </div>

                    <label for="pg-type">Institute Type:</label>
                    <select id="pg-type" required>
                        <option value="">Select</option>
                        <option value="gov">Government</option>
                        <option value="private">Private</option>
                        <option value="deemed">Deemed</option>
                    </select>

                    <label for="pg-course">Course:</label>
                    <select id="pg-course" required onchange="updateSpecializations()">
                        <option value="">Select</option>
                        <option value="MTech">M.Tech</option>
                        <option value="MSc">M.Sc</option>
                        <option value="MBA">MBA</option>
                    </select>

                    <label for="pg-specialization">Specialization:</label>
                    <select id="pg-specialization" required>
                        <option value="">Select</option>
                    </select>

                    <div class="grade-container">
                        <label for="pg-grade-type">Grade Type:</label>
                        <select id="pg-grade-type" class="grade-type-select" onchange="toggleGradeInput('pg')" required>
                            <option value="">Select</option>
                            <option value="cgpa">CGPA</option>
                            <option value="percentage">Percentage</option>
                        </select>
                        
                        <div class="grade-input">
                            <label for="pg-cgpa">CGPA (4-10):</label>
                            <input type="number" id="pg-cgpa" step="0.01" onchange="validateGrade(this, 'cgpa')" required>
                        </div>
                        
                        <div class="grade-input">
                            <label for="pg-percentage">Percentage (35-100):</label>
                            <input type="number" id="pg-percentage" step="0.01" onchange="validateGrade(this, 'percentage')" required>
                        </div>
                    </div>
                </div>

                <div id="phd" class="edu-section">
                    <label for="phd-status">Ph.D Status:</label>
                    <select id="phd-status" required onchange="togglePhdStatus()">
                        <option value="">Select</option>
                        <option value="no">No</option>
                        <option value="pursuing">Pursuing</option>
                        <option value="completed">Completed</option>
                    </select>

                    <div id="phd-fields-container">
                        <label for="phd-name">Name of Institution:</label>
                        <input type="text" id="phd-name" required>

                        <label for="phd-location">Location:</label>
                        <input type="text" id="phd-location" required>

                        <label>Duration:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="phd-start" required>
                            <input type="date" id="phd-end" required>
                        </div>

                        <label for="phd-type">Institute Type:</label>
                        <select id="phd-type" required>
                            <option value="">Select</option>
                            <option value="gov">Government</option>
                            <option value="private">Private</option>
                            <option value="deemed">Deemed</option>
                        </select>

                        <div id="phd-year-container">
                            <label for="phd-current-year">Current Year:</label>
                            <input type="number" id="phd-current-year" min="1" max="8" required>
                        </div>

                        <div class="grade-container">
                            <label for="phd-grade-type">Grade Type:</label>
                            <select id="phd-grade-type" class="grade-type-select" onchange="toggleGradeInput('phd')" required>
                                <option value="">Select</option>
                                <option value="cgpa">CGPA</option>
                                <option value="percentage">Percentage</option>
                            </select>
                            
                            <div class="grade-input">
                                <label for="phd-cgpa">CGPA (4-10):</label>
                                <input type="number" id="phd-cgpa" step="0.01" onchange="validateGrade(this, 'cgpa')" required>
                            </div>
                            
                            <div class="grade-input">
                                <label for="phd-percentage">Percentage (35-100):</label>
                                <input type="number" id="phd-percentage" step="0.01" onchange="validateGrade(this, 'percentage')" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button type="button" class="nav-button" onclick="showSection('personalDetails')">
                         Previous
                    </button>
                    <button type="button" id="edu-next-button" class="nav-button" onclick="showSection('professionalExperience')" disabled>
                        Next 
                    </button>
                </div>
            </form>
        </div>

        <div id="professionalExperience" class="form-section hidden">
            <h1>Professional Experience</h1>
            
            <div class="exp-buttons">
                <button type="button" id="addExpBtn" onclick="addExperienceCard()">Add Experience</button>
                <button type="button" id="noExpBtn" onclick="noExperience()">No Experience</button>
            </div>

            <div id="experienceList"></div>

            <div class="nav-buttons">
                <button type="button" class="nav-button" onclick="showSection('educationalDetails')">
                     Previous
                </button>
                <button type="button" id="exp-next-button" class="nav-button" onclick="showSection('certificateUpload')" disabled>
                    Next 
                </button>
            </div>
        </div>

        <div id="certificateUpload" class="form-section hidden">
            <h1>Upload Certificates</h1>
            
            <div class="certificate-section">
                <div class="certificate-group">
                    <h3>School Certificate</h3>
                    <input type="file" id="school-cert" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(this)">
                    <button type="button" class="upload-btn" onclick="triggerFileInput('school-cert')">Upload</button>
                    <div id="school-cert-name" class="file-name"></div>
                </div>

                <div class="certificate-group">
                    <h3>Intermediate Certificate</h3>
                    <input type="file" id="inter-cert" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(this)">
                    <button type="button" class="upload-btn" onclick="triggerFileInput('inter-cert')">Upload</button>
                    <div id="inter-cert-name" class="file-name"></div>
                </div>

                <div class="certificate-group">
                    <h3>UG Certificate</h3>
                    <input type="file" id="ug-cert" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(this)">
                    <button type="button" class="upload-btn" onclick="triggerFileInput('ug-cert')">Upload</button>
                    <div id="ug-cert-name" class="file-name"></div>
                </div>

                <div class="certificate-group">
                    <h3>PG Certificate</h3>
                    <input type="file" id="pg-cert" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(this)">
                    <button type="button" class="upload-btn" onclick="triggerFileInput('pg-cert')">Upload</button>
                    <div id="pg-cert-name" class="file-name"></div>
                </div>

                <div id="phd-cert-group" class="certificate-group" style="display:none;">
                    <h3>Ph.D Certificate</h3>
                    <input type="file" id="phd-cert" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(this)">
                    <button type="button" class="upload-btn" onclick="triggerFileInput('phd-cert')">Upload</button>
                    <div id="phd-cert-name" class="file-name"></div>
                </div>

                <div id="exp-certs"></div>
            </div>

            <div class="nav-buttons">
                <button type="button" class="nav-button" onclick="showSection('professionalExperience')">
                     Previous
                </button>
                <button type="button" class="nav-button" onclick="showSection('nextSection')">
                    Next 
                </button>
            </div>
        </div>

        <div id="confirmationSection" class="form-section hidden">
            <h2>Confirm Submission</h2>
            <div class="confirm-card" style="text-align: center; margin: 20px 0;">
                <h3>Are you sure you want to submit these details?</h3>
                <div class="button-group" style="margin: 20px 0;">
                    <button type="button" onclick="handleConfirmation('yes')" class="btn btn-primary">Yes</button>
                    <button type="button" onclick="handleConfirmation('no')" class="btn btn-secondary">No</button>
                </div>
                
                <div id="termsSection" style="display: none;">
                    <div class="terms-checkbox" style="margin: 20px 0;">
                        <input type="checkbox" id="termsCheck" onchange="toggleSubmitButton()">
                        <label for="termsCheck">
                            I hereby confirm that all details filled in this application are true and verified as per my academics and experience.
                        </label>
                    </div>
                    <button id="finalSubmitBtn" class="btn btn-success" onclick="submitForm()" disabled>
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>